from flask import Blueprint, render_template, redirect, url_for, jsonify
from flask_login import login_required, current_user
from app.models.user import User
from app.models.pet import Pet
from app.models.lesson import Lesson
from app.models.achievement import Achievement
from app.models.user_achievement import UserAchievement
from app.models.story import Story
from app import db
from sqlalchemy import func, desc
from datetime import datetime, timedelta

dashboard = Blueprint('dashboard', __name__)

@dashboard.route('/')
@login_required
def index():
    # Get user's pet
    user_pet = Pet.query.filter_by(user_id=current_user.id).first()
    
    # Get recent lessons completed
    recent_lessons = db.session.query(Lesson).join(
        User, Lesson.completed_by.contains(current_user)
    ).order_by(desc(Lesson.created_at)).limit(3).all() if hasattr(Lesson, 'completed_by') else []
    
    # Get user achievements
    user_achievements = db.session.query(Achievement).join(
        UserAchievement, Achievement.id == UserAchievement.achievement_id
    ).filter(UserAchievement.user_id == current_user.id).order_by(
        desc(UserAchievement.earned_at)
    ).limit(5).all()
    
    # Get user's recent stories
    user_stories = Story.query.filter_by(author_id=current_user.id).order_by(
        desc(Story.created_at)
    ).limit(3).all()
    
    # Calculate streak (simplified - would need lesson completion tracking)
    learning_streak = calculate_learning_streak(current_user.id)
    
    # Get leaderboard position
    leaderboard_position = get_user_leaderboard_position(current_user.id)
    
    # Weekly stats
    week_ago = datetime.utcnow() - timedelta(days=7)
    weekly_stats = {
        'lessons_completed': 0,  # Would need proper tracking
        'stories_created': Story.query.filter(
            Story.author_id == current_user.id,
            Story.created_at >= week_ago
        ).count(),
        'points_earned': 0,  # Would need point history tracking
        'pet_interactions': 0  # Would need interaction tracking
    }
    
    return render_template('dashboard/index.html',
                         user_pet=user_pet,
                         recent_lessons=recent_lessons,
                         user_achievements=user_achievements,
                         user_stories=user_stories,
                         learning_streak=learning_streak,
                         leaderboard_position=leaderboard_position,
                         weekly_stats=weekly_stats)

@dashboard.route('/leaderboard')
@login_required
def leaderboard():
    # Get top users by points
    top_users = User.query.order_by(desc(User.total_points)).limit(50).all()
    
    # Get user's position
    user_position = get_user_leaderboard_position(current_user.id)
    
    return render_template('dashboard/leaderboard.html',
                         top_users=top_users,
                         user_position=user_position,
                         current_user_id=current_user.id)

@dashboard.route('/achievements')
@login_required
def achievements():
    # Get all achievements with user's completion status
    all_achievements = Achievement.query.all()
    user_achievement_ids = {ua.achievement_id for ua in 
                           UserAchievement.query.filter_by(user_id=current_user.id).all()}
    
    completed_achievements = []
    pending_achievements = []
    
    for achievement in all_achievements:
        if achievement.id in user_achievement_ids:
            # Get the earning date
            user_ach = UserAchievement.query.filter_by(
                user_id=current_user.id, 
                achievement_id=achievement.id
            ).first()
            achievement.earned_at = user_ach.earned_at
            completed_achievements.append(achievement)
        else:
            pending_achievements.append(achievement)
    
    return render_template('dashboard/achievements.html',
                         completed_achievements=completed_achievements,
                         pending_achievements=pending_achievements)

@dashboard.route('/stats')
@login_required
def stats():
    # Comprehensive user statistics
    stats = {
        'total_points': current_user.total_points,
        'level': current_user.level,
        'achievements_count': UserAchievement.query.filter_by(user_id=current_user.id).count(),
        'stories_created': Story.query.filter_by(author_id=current_user.id).count(),
        'learning_streak': calculate_learning_streak(current_user.id),
        'account_age': (datetime.utcnow() - current_user.created_at).days,
        'pet_stats': None
    }
    
    # Get pet stats
    user_pet = Pet.query.filter_by(user_id=current_user.id).first()
    if user_pet:
        stats['pet_stats'] = {
            'name': user_pet.name,
            'type': user_pet.pet_type,
            'level': user_pet.level,
            'happiness': user_pet.happiness,
            'health': user_pet.health,
            'experience': user_pet.experience
        }
    
    return render_template('dashboard/stats.html', stats=stats)

@dashboard.route('/api/quick_stats')
@login_required
def api_quick_stats():
    """API endpoint for quick stats updates"""
    user_pet = Pet.query.filter_by(user_id=current_user.id).first()
    
    return jsonify({
        'points': current_user.total_points,
        'level': current_user.level,
        'pet': {
            'happiness': user_pet.happiness if user_pet else 0,
            'hunger': user_pet.hunger if user_pet else 0,
            'health': user_pet.health if user_pet else 0,
            'energy': user_pet.energy if user_pet else 0,
            'needs_attention': (user_pet.hunger < 30 or user_pet.happiness < 40) if user_pet else False
        } if user_pet else None
    })

def calculate_learning_streak(user_id):
    """Calculate the user's current learning streak"""
    # This is a simplified version - in production, you'd track daily lesson completions
    # For now, return a mock streak based on recent activity
    recent_activity = Story.query.filter_by(author_id=user_id).filter(
        Story.created_at >= datetime.utcnow() - timedelta(days=7)
    ).count()
    
    return min(recent_activity, 7)  # Cap at 7 days

def get_user_leaderboard_position(user_id):
    """Get user's position in the leaderboard"""
    user = User.query.get(user_id)
    if not user:
        return None
        
    # Count users with higher points
    higher_users = User.query.filter(User.total_points > user.total_points).count()
    return higher_users + 1

@dashboard.route('/tutorial')
@login_required
def tutorial():
    """Interactive tutorial for new users"""
    return render_template('dashboard/tutorial.html')

@dashboard.route('/settings')
@login_required
def settings():
    """User settings page"""
    return render_template('dashboard/settings.html')

@dashboard.route('/help')
@login_required
def help():
    """Help and FAQ page"""
    return render_template('dashboard/help.html')